package org.flysim.UI;

import java.awt.Color;

import javax.media.j3d.AmbientLight;
import javax.media.j3d.Appearance;
import javax.media.j3d.BoundingSphere;
import javax.media.j3d.BranchGroup;
import javax.media.j3d.DirectionalLight;
import javax.media.j3d.Material;
import javax.media.j3d.Node;
import javax.media.j3d.Transform3D;
import javax.media.j3d.TransformGroup;
import javax.vecmath.Color3f;
import javax.vecmath.Point3d;
import javax.vecmath.Vector3f;

import org.flysim.Simulator.Simulator;

import com.sun.j3d.utils.behaviors.keyboard.KeyNavigatorBehavior;
import com.sun.j3d.utils.behaviors.mouse.MouseRotate;
import com.sun.j3d.utils.geometry.Box;
import com.sun.j3d.utils.universe.SimpleUniverse;

public class Visualizator implements Runnable {
	private Simulator simulator;
	
    private SimpleUniverse universe;
    private Appearance cubeAppearance;
    private BranchGroup rootGroup;
    private BoundingSphere bounds;

	private Appearance copterMainEngineAppearance;

	private Appearance copterEngineAppearance;
	
	public Visualizator(Simulator s) {
		simulator = s;
	}
	
	public void run() {
		while (true) {
			//System.out.println("VT");
		}
	}
	
    public void init() {
        createUniverse();
        createAppearance();
        //createCubeOfCubes();

        createCopter();

        createLights();
        createBehaviourInteractors();
        universe.getViewingPlatform().setNominalViewingTransform();

        // add the cube group of objects to SimpleUnvirse object
        universe.addBranchGraph(rootGroup);
    }
    
    private void createUniverse() {
        universe = new SimpleUniverse();
        rootGroup = new BranchGroup();
        bounds = new BoundingSphere(new Point3d(0.0, 0.0, 0.0), 100.0);
        
    }

    private void setupAppearance(Appearance app, Color col) {
        Color3f ambientColour = new Color3f();
        ambientColour.set(col);
        Color3f emissiveColour = new Color3f(0.0f, 0.0f, 0.0f);
        Color3f specularColour = new Color3f(1.0f, 1.0f, 1.0f);
        Color3f diffuseColour = new Color3f();
        diffuseColour.set(col);
        float shininess = 20.0f;
        app.setMaterial(new Material(ambientColour, emissiveColour,
                diffuseColour, specularColour, shininess));
    }
    
    private void createAppearance() {
        cubeAppearance = new Appearance();
        setupAppearance(cubeAppearance, Color.GRAY);

        copterMainEngineAppearance = new Appearance();
        setupAppearance(copterMainEngineAppearance, Color.RED);

        copterEngineAppearance = new Appearance();
        setupAppearance(copterEngineAppearance, Color.GREEN);
    }
    
    private void createCubeOfCubes() {
        // build up a cube of 10 cube for each axis (x, y, z)
        for (float x = -.5f; x <= .5f; x = x + .1f) {
            for (float y = -.5f; y <= .5f; y += .1f) {
                for (float z = -.5f; z <= .5f; z += .1f) {
                    Box box = new Box(0.02f, 0.02f, 0.02f, cubeAppearance);
                    TransformGroup tg = new TransformGroup();
                    Transform3D transform = new Transform3D();
                    Vector3f vector = new Vector3f(x, y, z);
                    transform.setTranslation(vector);
                    tg.setTransform(transform);
                    tg.addChild(box);
                    rootGroup.addChild(tg);
                }
            }
        }
    }

    private Node addNodeAtCoord(Node box, float x, float y, float z) {
        TransformGroup tg = new TransformGroup();
        Transform3D transform = new Transform3D();
        Vector3f vector = new Vector3f(x, y, z);
        transform.setTranslation(vector);
        tg.setTransform(transform);
        tg.addChild(box);
        
        return tg;
//        rootGroup.addChild(tg);
    }
    
    private void createCopter() {
    	
        TransformGroup tg = new TransformGroup();
        Transform3D transform = new Transform3D();
        Vector3f vector = new Vector3f(0f, 0f, 0f);
        transform.setTranslation(vector);
        tg.setTransform(transform);
        rootGroup.addChild(tg);
    	
    	
    	Box boxLeftEngine = new Box(0.05f, 0.05f, 0.05f, copterEngineAppearance);
    	tg.addChild(addNodeAtCoord(boxLeftEngine, -0.25f, 0f, 0f));
    	Box boxRightEngine = new Box(0.05f, 0.05f, 0.05f, copterEngineAppearance); 
    	addBoxAtCoord(boxRightEngine, 0.25f, 0f, 0f);
    	Box boxForwardEngine = new Box(0.05f, 0.05f, 0.05f, copterMainEngineAppearance); 
    	addBoxAtCoord(boxForwardEngine, 0f, 0.25f, 0f);
    	Box boxBackwardEngine = new Box(0.05f, 0.05f, 0.05f, copterEngineAppearance); 
    	addBoxAtCoord(boxBackwardEngine, 0f, -0.25f, 0f);
    	
    	Box boxFwBw = new Box(0.005f, 0.25f, 0.005f, cubeAppearance);
    	addBoxAtCoord(boxFwBw, 0f, 0f, 0f);
    	Box boxLfRg = new Box(0.25f, 0.005f, 0.005f, cubeAppearance);
    	addBoxAtCoord(boxLfRg, 0f, 0f, 0f);
    	
    }
    
    private void createLights() {
        Color3f ambientLightColour = new Color3f(0.9f, 0.9f, 0.9f);
        AmbientLight ambientLight = new AmbientLight(ambientLightColour);
        ambientLight.setInfluencingBounds(bounds);
        Color3f directionLightColour = new Color3f(1.0f, 1.0f, 1.0f);
        Vector3f directionLightDir = new Vector3f(-1.0f, -1.0f, -1.0f);
        DirectionalLight directionLight = new DirectionalLight(directionLightColour, directionLightDir);
        directionLight.setInfluencingBounds(bounds);
        rootGroup.addChild(ambientLight);
        rootGroup.addChild(directionLight);
    }
    
    private void createBehaviourInteractors() {
        TransformGroup viewTransformGroup =
                universe.getViewingPlatform().getViewPlatformTransform();

        KeyNavigatorBehavior keyInteractor =
                new KeyNavigatorBehavior(viewTransformGroup);

        BoundingSphere movingBounds = new BoundingSphere(new Point3d(0.0, 0.0,
        0.0), 100.0);
        keyInteractor.setSchedulingBounds(movingBounds);
        rootGroup.addChild(keyInteractor);

        MouseRotate behavior = new MouseRotate();
        behavior.setTransformGroup(viewTransformGroup);
        rootGroup.addChild(behavior);
        behavior.setSchedulingBounds(bounds);
    }

}
